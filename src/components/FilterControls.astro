---
export interface Props {
    categories: string[];
    selectedCategory?: string;
    selectedTags?: string[];
    allTags: string[];
}

const {
    categories,
    selectedCategory,
    selectedTags = [],
    allTags,
} = Astro.props;
---

<div class="filter-controls">
    <div class="filter-group">
        <label for="search">Search</label>
        <input
            type="text"
            id="search"
            placeholder="Search entries..."
            class="search-input"
        />
    </div>

    <div class="filter-group">
        <label for="category">Category</label>
        <select id="category" class="category-select">
            <option value="">All Categories</option>
            {
                categories.map((cat) => (
                    <option value={cat} selected={selectedCategory === cat}>
                        {cat.charAt(0).toUpperCase() + cat.slice(1)}
                    </option>
                ))
            }
        </select>
    </div>

    <div class="filter-group">
        <label>Tags</label>
        <div class="tags-container">
            {
                allTags.map((tag) => (
                    <label class="tag-checkbox">
                        <input
                            type="checkbox"
                            value={tag}
                            checked={selectedTags.includes(tag)}
                            class="tag-input"
                        />
                        <span class="tag-label">{tag}</span>
                    </label>
                ))
            }
        </div>
    </div>

    <div class="filter-actions">
        <button type="button" class="clear-filters">Clear Filters</button>
    </div>
</div>

<style>
    .filter-controls {
        background: white;
        border: 1px solid #e5e5e5;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .filter-group label {
        font-weight: 600;
        color: #333;
        font-size: 0.875rem;
    }

    .search-input,
    .category-select {
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 0.875rem;
    }

    .search-input:focus,
    .category-select:focus {
        outline: none;
        border-color: #007acc;
        box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.1);
    }

    .tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        max-height: 120px;
        overflow-y: auto;
    }

    .tag-checkbox {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        cursor: pointer;
        font-size: 0.75rem;
    }

    .tag-input {
        margin: 0;
    }

    .tag-label {
        background: #f5f5f5;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        transition: background-color 0.2s;
    }

    .tag-checkbox:has(.tag-input:checked) .tag-label {
        background: #007acc;
        color: white;
    }

    .clear-filters {
        padding: 0.5rem 1rem;
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.875rem;
        transition: background-color 0.2s;
    }

    .clear-filters:hover {
        background: #e5e7eb;
    }

    .filter-actions {
        display: flex;
        align-items: end;
    }

    @media (max-width: 768px) {
        .filter-controls {
            grid-template-columns: 1fr;
            padding: 1rem;
        }

        .tags-container {
            max-height: 80px;
        }
    }
</style>

<script>
    // Search functionality
    const searchInput = document.getElementById("search") as HTMLInputElement;
    const categorySelect = document.getElementById(
        "category",
    ) as HTMLSelectElement;
    const tagInputs = document.querySelectorAll(
        ".tag-input",
    ) as NodeListOf<HTMLInputElement>;
    const clearButton = document.querySelector(
        ".clear-filters",
    ) as HTMLButtonElement;

    function filterEntries() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedCategory = categorySelect.value;
        const selectedTags = Array.from(tagInputs)
            .filter((input) => input.checked)
            .map((input) => input.value);

        const entries = document.querySelectorAll(".entry-card");

        entries.forEach((entry) => {
            const entryElement = entry as HTMLElement;
            const title =
                entryElement
                    .querySelector("h2 a")
                    ?.textContent?.toLowerCase() || "";
            const content =
                entryElement
                    .querySelector(".entry-content")
                    ?.textContent?.toLowerCase() || "";
            const category =
                entryElement
                    .querySelector(".category")
                    ?.textContent?.toLowerCase() || "";
            const entryTags = Array.from(
                entryElement.querySelectorAll(".tag"),
            ).map((tag) => tag.textContent || "");

            const matchesSearch =
                !searchTerm ||
                title.includes(searchTerm) ||
                content.includes(searchTerm);

            const matchesCategory =
                !selectedCategory || category === selectedCategory;

            const matchesTags =
                selectedTags.length === 0 ||
                selectedTags.every((tag) => entryTags.includes(tag));

            if (matchesSearch && matchesCategory && matchesTags) {
                entryElement.style.display = "block";
            } else {
                entryElement.style.display = "none";
            }
        });

        updateResultsCount();
    }

    function updateResultsCount() {
        const visibleEntries = document.querySelectorAll(
            '.entry-card[style*="display: block"], .entry-card:not([style*="display: none"])',
        );
        const totalEntries = document.querySelectorAll(".entry-card");

        let resultsElement = document.querySelector(".results-count");
        if (!resultsElement) {
            resultsElement = document.createElement("div");
            resultsElement.className = "results-count";
            (resultsElement as HTMLElement).style.cssText =
                "margin: 1rem 0; font-weight: 600; color: #666;";
            document
                .querySelector(".filter-controls")
                ?.insertAdjacentElement("afterend", resultsElement);
        }

        resultsElement.textContent = `Showing ${visibleEntries.length} of ${totalEntries.length} entries`;
    }

    function clearFilters() {
        searchInput.value = "";
        categorySelect.value = "";
        tagInputs.forEach((input) => (input.checked = false));
        filterEntries();
    }

    // Event listeners
    searchInput.addEventListener("input", filterEntries);
    categorySelect.addEventListener("change", filterEntries);
    tagInputs.forEach((input) =>
        input.addEventListener("change", filterEntries),
    );
    clearButton.addEventListener("click", clearFilters);

    // Initialize
    updateResultsCount();
</script>
